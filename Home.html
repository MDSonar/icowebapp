<!DOCTYPE html>
<html>
<head>
    <title>FWXAPI</title>
    <style>
        body{font-family: Arial, Helvetica, sans-serif; padding: 20px;}
        .data-container{margin-top: 20px;background: #f4f4f4; padding: 15px;border-radius: 8px;box-shadow: 0 0 5px rgba(0,0,0,0.1);}
        h3 {color: #2c3e50;}
        table{width: 100%;text-align: left;background-color: #fff;}
        th{background-color: #3498db;}
        td,th{ padding: 8px;}
        button{background-color: #3498db;color: white;border: none;padding: 10px 20px;margin: 10px 10px 0 0;border-radius: 5px;cursor: pointer;font-size: 14px;transition: background-color 0.3s ease;}
        button:hover{background-color: #2980b9;}
        input[type="number"],select{padding: 10px;font-size: 14px;margin: 10px 10px 0 0;border: 1px solid #ccc;border-radius: 5px;outline:none;transition: border-color 0.3s ease, box-shadow 0.3s ease;width: 180px;}
        input[type="number"]:focus,select:focus{border-color: #3498db;box-shadow: 0 0 5px rgba(52, 152, 219,0.5);}
        .collapsible{background-color: #3498db;color: white;cursor: pointer;padding: 12px;width: 100%;border: none;text-align: left;outline: none;font-size: 16px;border-radius: 5px;margin-top: 20px;transition: background-color 0.3s ease;}
        .collapsible:hover{background-color: #2980b9;}
        .content{padding: 10px 15px;display: none;overflow: hidden;background-color: #f9f9f9;border: 1px solid #ddd;border-top: none;border-radius: 0 0 5px 5px; margin-bottom: 10px;}
        #tokenTimer{display: inline-block;background-color: #ecf0f1;color: #2980b9;padding: 10px 15px; margin-left: 15px;border-radius: 5px;font-size: 14px;box-shadow: 0 0 4px rgba(0,0,0,0.1);vertical-align: middle;}
    </style>
</head>
<body>

<button class="collapsible">Authorization</button>
<div class="content">
    <button onclick="logout()">Logout</button>
    <span id="tokenTimer" >Checking token...</span>
    <pre id="loginStatus" class="data-container">Authenticating...</pre>    
</div>

<button class="collapsible">Manual Request GET POST</button>   
<div class="content">
    <button onclick="getData()">Fetch via GET</button>
    <button onclick="postData()">Fetch via POST</button>
    <pre id="output1" class="data-container">Press any button for data</pre>
</div>

<button class="collapsible">Live Data</button>
<div class="content">
    <label for="refreshRate">Refresh</label>
    <select id="refreshRate">
        <option value="200">200 ms</option>
        <option value="1000">1 s</option>
        <option value="5000" selected>5 s</option>
        <option value="10000">10 s</option>
    </select>
        <pre id="output2" class="data-container">Waiting for data...</pre>
</div>

<button class="collapsible">Write POST </button>
<div class="content">
    <input type="number" id="writeValue" placeholder="Enter Value">
    <button onclick="writeData()">Write</button>
    <pre id="output3" class="data-container"></pre>
</div>

<button class="collapsible">Read DataSets</button>
<div class="content">    
    <button onclick="readDb()">Refresh</button>
    <pre id="readDataSet" class="data-container">Waiting for data...</pre>
</div>

<!--Config-->
<script>

    const CLIENT_ID = 'TestRESTApi';
    const CLIENT_SECRET = '123456789';
    const REDIRECT_URI = 'https://coe-win11-1/AnyGlass/Home.html';
    const AUTH_URL = 'https://coe-win11-1/fwxserverweb/security/connect/authorize';
    const TOKEN_URL = 'https://coe-win11-1/fwxserverweb/security/connect/token';
    const SCOPE = 'fwxserver offline_access';
    const API_URL = 'https://coe-win11-1/fwxapi/rest';
    let accessToken = localStorage.getItem("accessToken") || "";

    const output1 = document.getElementById('output1');
    const output2 = document.getElementById('output2');
    const loginStatus = document.getElementById('loginStatus');

    async function login(){
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        if(!username || !password){
            loginStatus.textContent = "Please enter both username and passoword.";
            return;
        }

        try{
            const response = await fetch('https://coe-win11-1/fwxserverweb/security/connect/token',{
                method:'POST',
                headers:{
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `grant_type=password&client_id=TestRESTApi&client_secret=123456789&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&scope=fwxserver%20offline_access`
            });
            const data = await response.json();
            if(data.access_token){
                accessToken = data.access_token;
                loginStatus.textContent = "Login Scuccessful!";
                console.log('Token:',accessToken);
            }else{
                loginStatus.textContent = "Login Failed! Check credentials.";
            }
        }catch(err){
            if (err instanceof Response){
                const text = await err.text();
                loginStatus.textContent = "Login Error:\n"+text;
            }else{
                loginStatus.textContent = "Login Error: "+err.message;
            }
        }
    }
    
    function logout(){
        localStorage.removeItem("accessToken");
        window.location.href = REDIRECT_URI;
    }

    function checkAuth(){
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');

        if(accessToken){
            loginStatus.textContent = "Logged in with valid token.";
            updateTokenTimer();
            return;
        }
        if(error){
            loginStatus.textContent = "Auth Error :"+ error;
            return; 
        }

        if(code){
            loginStatus.textContent = "Exchaning code for token...";
            fetch(TOKEN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=authorization_code&code=${code}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}`
            })
            .then(res => res.json())
            .then(data => {
                if(data.access_token){
                    localStorage.setItem("accessToken",data.access_token);
                    loginStatus.textContent = "Token received!";
                    const expiresIn = data.expires_in;
                    const expirationTime = Date.now() + expiresIn * 1000;

                    localStorage.setItem("tokenExpiry",expirationTime);
                    window.history.replaceState({},document.title,REDIRECT_URI);
                    updateTokenTimer();
                    accessToken = data.access_token;
                }else{
                    loginStatus.textContent = "Token exchage failed:\n"+JSON.stringify(data,null,2);
                }
            })
            .catch(err => loginStatus.textContent = "Token Error: "+ err);
        }else{
            const state = 'xyz' + Date.now();
            const url = `${AUTH_URL}?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPE)}&state=${state}`;
            window.location.href = url;
        }
    }

    async function getData(){
    try{
        const response = await fetch('https://coe-win11-1/fwxapi/rest/data/?pointName=@sim64:Float.Random(1,-50.0,50.0,0).Value',{
            headers:{'Authorization':'Bearer ' + accessToken}
        });
        const data = await response.json();
        output1.textContent = 'Reading real-time values (HTTP GET):\n'+JSON.stringify(data,null,2);
    }catch(err){
        output1.textContent = 'GET Error:\n'+err;
    }
    }

    async function postData(){
    try{
        const response = await fetch('https://coe-win11-1/fwxapi/rest/data',{
            method: 'POST',
            headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer ' + accessToken
            },
            body: JSON.stringify({
            "PointName": ["ac:TestAPI/SimFloatStep","ac:TestAPI/SimLongRamp","ac:TestAPI/SimLongRandom"]
            })
        });
        const data = await response.json();
        output1.textContent = 'Reading real-time values (HTTP POST):\n' + JSON.stringify(data,null,2);
    }catch(err){
        output1.textContent = 'POST Error:\n'+err;
    }
    }

    const writeOutput = document.getElementById('output3');
    async function writeData(){
        const value = document.getElementById('writeValue').value;
        if(value === ''){
            writeOutput.textContent = 'Entre value...';
            return;
        }
        try{
            const response = await fetch('https://coe-win11-1/fwxapi/rest/data/write',{
                method: 'POST',
                headers:{
                    'Content-Type':'application/json',
                    'Authorization':'Bearer ' + accessToken
                },
                body: JSON.stringify([{
                    "PointName": "ac:TestAPI/SimStaticLong",
                    "Value": parseFloat(value)
                }])
            });
            const result = await response.json();
            writeOutput.textContent = "Writing Real-Time Value HTTP POST:\n"+JSON.stringify(result,null,2);
        }catch(err){
            writeOutput.textContent = "Write Error: " + err;
        }
    }

    const readDataSet = document.getElementById('readDataSet');
    async function readDb(){
        try{
            const response = await fetch('https://coe-win11-1/fwxapi/rest/dataset?PointName=db:Northwind.Orders',{
                headers:{'Authorization':'Bearer ' + accessToken}
            });
            const result = await response.json();
            readDataSet.textContent = "Reading DataSets HTTPS GET:\n"+ JSON.stringify(result,null,2);
        }catch(err){
            readDataSet.textContent="ReadDB Error:" + err;
        }
    }

    async function fetchLiveData(){
    try{
        const response = await fetch('https://coe-win11-1/fwxapi/rest/data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json','Authorization':'Bearer ' + accessToken},
            body: JSON.stringify({
                "PointName": [
                    "ac:TestAPI/SimFloatStep",
                    "ac:TestAPI/SimLongRamp",
                    "ac:TestAPI/SimLongRandom",
                    "ac:TestAPI/SimStaticLong"
                ]
            })
        });
        const data = await response.json();

        let html = "<table border='1' cellpadding='6' cellspacing='0' style='border-collapse:collapse;'>";
        html += "<tr><th>Point Name</th><th>Value</th><th>Timestamp</th><th>Quality</th></tr>";

        data.forEach(point => {
            const time = new Date(point.timestamp).toLocaleString(); // Fixed 'Data' typo and method name
            html += `<tr>
                        <td>${point.pointName}</td> 
                        <td>${point.value}</td>
                        <td>${time}</td>
                        <td>${point.quality}</td>
                    </tr>`;  // Closed tr properly
        });

        html += "</table>";
        output2.innerHTML = html;
    } catch (err) {
        output2.textContent = 'Live Fetch Error:\n' + err;
    }
    }

    let refreshInterval = 5000;
    let intervalId = null;
    document.getElementById('refreshRate').addEventListener('change', function () {
        refreshInterval = parseInt(this.value);
        clearInterval(intervalId);
        intervalId = setInterval(fetchLiveData, refreshInterval);
    });
    fetchLiveData();

    checkAuth();

    //Token time function
    function updateTokenTimer(){
        const expiry = parseInt(localStorage.getItem("tokenExpiry"),10);
        const now = Date.now();
        if(!expiry || expiry < now){
            document.getElementById("tokenTimer").textContent = "Token expired.";
            return;
        }
        const remaining = Math.floor((expiry-now)/1000);
        const min = Math.floor(remaining/60);
        const sec = remaining % 60;
        document.getElementById("tokenTimer").textContent = `Token valid for: ${min}m ${sec}s`;
    }

    document.querySelectorAll(".collapsible").forEach(btn =>{
        btn.addEventListener("click",function(){
            this.classList.toggle("active");
            let content = this.nextElementSibling;
            //content.style.display = content.style.display === "block" ? "none": "block";

            const wasHidden = content.style.display !== "block";
            content.style.display = wasHidden ? "block" : "none";
            
            //when the authorization section opens, update token timer
            if(this.textContent.includes("Authorization") && !wasHidden){
                updateTokenTimer();
            }
        });
    });

</script>
</body>
</html>
